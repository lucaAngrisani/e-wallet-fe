<div class="flex flex-col gap-6">
  <!-- Hero Section & Snapshot -->

  <!-- Total Balance -->
  <app-card>
    <div class="flex flex-col h-full justify-between">
      <div class="text-sm font-medium opacity-70">
        {{ "dashboard.account-list" | translate }}
      </div>
      <div class="text-4xl font-bold mt-2">
        {{ accountService.totalBalance() | currency: "EUR" }}
      </div>
    </div>
  </app-card>

  <!-- Asset Allocation -->
  <app-card>
    <div class="flex flex-col h-full">
      <div class="text-lg font-bold mb-4">Asset Allocation</div>
      <div class="flex-1 min-h-[200px]">
        <apx-chart
          class="w-full"
          [series]="accountService.balancePie().series"
          [chart]="accountService.balancePie().chart"
          [legend]="accountService.balancePie().legend"
          [responsive]="accountService.balancePie().responsive"
          [labels]="accountService.balancePie().labels"
          [theme]="accountService.balancePie().theme!"
        >
        </apx-chart>
      </div>
    </div>
  </app-card>

  <!-- Operational Section -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Recent Transactions -->
    <app-card class="h-full">
      <div class="flex justify-between items-center mb-4">
        <div class="text-lg font-bold">
          {{ "dashboard.recent-transactions" | translate }}
        </div>
        <a
          [routerLink]="[
            '/',
            ROUTE.AUTH.BASE_PATH,
            ROUTE.AUTH.TRANSACTION_LIST,
          ]"
          class="text-sm text-blue-500 hover:text-blue-700 font-medium"
        >
          View All
        </a>
      </div>

      @if (recentTransactions().length > 0) {
        <app-table
          [enableCustomActions]="false"
          [columns]="transactionService.columns()"
          [values]="recentTransactions()"
        >
          <custom-column name="amount">
            <ng-template let-item="row" bodyTemplate>
              <div
                [ngClass]="{
                  'text-green-600 dark:text-green-400':
                    item.type?.name === TRANSACTION_TYPE_IN,
                  'text-red-600 dark:text-red-400':
                    item.type?.name === TRANSACTION_TYPE_OUT,
                }"
              >
                {{ item.amount | currency: item.currency?.code }}
              </div>
            </ng-template>
          </custom-column>

          <custom-column name="category">
            <ng-template let-item="row" bodyTemplate>
              <app-category-label
                [category]="item.category"
              ></app-category-label>
            </ng-template>
          </custom-column>

          <custom-column name="account">
            <ng-template let-item="row" bodyTemplate>
              {{ item.account?.name }}
            </ng-template>
          </custom-column>

          <custom-column name="date">
            <ng-template let-item="row" bodyTemplate>
              {{ item.date | date: "dd/MM/yyyy" }}
            </ng-template>
          </custom-column>
        </app-table>
      } @else {
        <app-empty-state
          icon="receipt_long"
          title="empty-state.title"
          description="empty-state.description"
          actionLabel="common.add"
          [actionRoute]="[
            '/',
            ROUTE.AUTH.BASE_PATH,
            ROUTE.AUTH.TRANSACTION_NEW,
          ]"
        >
        </app-empty-state>
      }
    </app-card>

    <!-- Next Plan -->
    <app-card class="h-full">
      <div class="text-lg font-bold mb-4">
        {{ "dashboard.next-plan" | translate }}
      </div>

      <app-table
        [enableCustomActions]="true"
        [columns]="dashboardService.nextPlanColumns()"
        [values]="dashboardService.nextPlanValues()"
      >
        <custom-column name="amount">
          <ng-template let-item="row" bodyTemplate>
            <div
              [ngClass]="{
                'text-green-600 dark:text-green-400':
                  item.type?.name === TRANSACTION_TYPE_IN,
                'text-red-600 dark:text-red-400':
                  item.type?.name === TRANSACTION_TYPE_OUT,
              }"
            >
              {{ item.amount | currency: item.currency }}
            </div>
          </ng-template>
        </custom-column>

        <custom-column name="date">
          <ng-template let-item="row" bodyTemplate>
            {{ item.date | date: "dd/MM/yyyy" }}
          </ng-template>
        </custom-column>
      </app-table>
    </app-card>
  </div>

  <!-- Detailed Analysis Section -->
  <div class="flex flex-col gap-6">
    <div class="flex items-center justify-between">
      <h2 class="text-2xl font-bold">Financial Analysis</h2>
    </div>

    <!-- Date Control -->
    <mat-expansion-panel
      class="!rounded-lg !bg-white dark:!bg-gray-800 border dark:border-gray-700"
      [expanded]="false"
    >
      <mat-expansion-panel-header>
        <mat-panel-title class="flex items-center gap-2">
          <mat-icon>date_range</mat-icon>
          <span>
            {{ selectedInterval() }}
            ({{ dateRangeForm.controls.start.value | date: "dd/MM/yyyy" }} -
            {{ dateRangeForm.controls.end.value | date: "dd/MM/yyyy" }})
          </span>
        </mat-panel-title>
      </mat-expansion-panel-header>

      <div
        class="flex flex-col md:flex-row justify-center items-start md:items-center gap-4 py-4"
      >
        <form
          [formGroup]="dateRangeForm"
          (ngSubmit)="onSubmit()"
          class="flex flex-col gap-2"
        >
          <mat-form-field appearance="outline" subscriptSizing="dynamic">
            <mat-label>{{ "dashboard.date-range" | translate }}</mat-label>
            <mat-date-range-input [rangePicker]="picker">
              <input
                matStartDate
                placeholder="Start date"
                formControlName="start"
              />
              <input
                matEndDate
                placeholder="End date"
                formControlName="end"
                (dateChange)="onSubmit()"
              />
            </mat-date-range-input>

            <mat-datepicker-toggle
              matIconSuffix
              [for]="picker"
            ></mat-datepicker-toggle>
            <mat-date-range-picker #picker></mat-date-range-picker>
          </mat-form-field>
        </form>

        <div class="flex flex-wrap gap-2">
          <button mat-stroked-button (click)="selectLastNDays(30)">
            {{ "dashboard.select-last-30-days" | translate }}
          </button>

          <button mat-stroked-button (click)="selectLastNDays(90)">
            {{ "dashboard.select-last-90-days" | translate }}
          </button>

          <button mat-stroked-button (click)="selectLastNDays(365)">
            {{ "dashboard.select-last-year" | translate }}
          </button>
        </div>
      </div>
    </mat-expansion-panel>

    <!-- Trend Chart -->
    <app-card>
      <div class="text-lg font-bold mb-4">Overview Trend</div>
      <div class="w-full">
        <apx-chart
          class="w-full h-full"
          [series]="dashboardService.areaChart().series"
          [chart]="dashboardService.areaChart().chart"
          [xaxis]="dashboardService.areaChart().xaxis"
          [dataLabels]="dashboardService.areaChart().dataLabels"
          [stroke]="dashboardService.areaChart().stroke"
          [fill]="dashboardService.areaChart().fill"
          [tooltip]="dashboardService.areaChart().tooltip"
          [colors]="['#0B5FFF']"
          [theme]="dashboardService.areaChart().theme!"
          [legend]="dashboardService.areaChart().legend!"
        >
        </apx-chart>
      </div>
    </app-card>

    <!-- Income & Outcome Breakdown -->
    <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
      <!-- Income -->
      <app-card>
        <div
          class="flex justify-between items-center mb-4 border-b border-gray-100 dark:border-gray-700 pb-2"
        >
          <div class="text-lg font-bold">
            {{ "dashboard.income.total" | translate }}
          </div>
          <div class="text-xl font-bold text-green-600 dark:text-green-400">
            {{ dashboardService.totalBalanceIn() | currency: "EUR" }}
          </div>
        </div>

        <div class="flex flex-col gap-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <apx-chart
              [series]="dashboardService.incomeDonut().series"
              [chart]="dashboardService.incomeDonut().chart"
              [legend]="dashboardService.incomeDonut().legend"
              [responsive]="dashboardService.incomeDonut().responsive"
              [labels]="dashboardService.incomeDonut().labels"
              [theme]="dashboardService.incomeDonut().theme!"
            >
            </apx-chart>
            <apx-chart
              [series]="dashboardService.incomeBar().series"
              [chart]="dashboardService.incomeBar().chart"
              [xaxis]="dashboardService.incomeBar().xaxis"
              [dataLabels]="dashboardService.incomeBar().dataLabels"
              [plotOptions]="dashboardService.incomeBar().plotOptions"
              [theme]="dashboardService.incomeBar().theme!"
            >
            </apx-chart>
          </div>

          <app-table
            [enableCustomActions]="true"
            [columns]="dashboardService.incomeColumns()"
            [values]="dashboardService.incomeValues()"
          >
            <custom-column name="category">
              <ng-template let-item="row" bodyTemplate>
                <app-category-label
                  [category]="{
                    name: item.category,
                    icon: item.icon,
                    color: item.color,
                  }"
                ></app-category-label>
              </ng-template>
            </custom-column>

            <custom-column name="amount">
              <ng-template let-item="row" bodyTemplate>
                <div class="text-green-600 dark:text-green-400 font-medium">
                  {{ item.amount | currency: item.currency }}
                  <span class="text-xs opacity-75"
                    >({{ item.percentage | percent: "1.2-2" }})</span
                  >
                </div>
              </ng-template>
            </custom-column>

            <custom-column name="actions">
              <ng-template let-item="row" bodyTemplate>
                <button
                  mat-icon-button
                  (click)="goToCategoryTransactionsDetail(item.id)"
                  aria-label="see-more"
                >
                  <mat-icon>chevron_right</mat-icon>
                </button>
              </ng-template>
            </custom-column>
          </app-table>
        </div>
      </app-card>

      <!-- Outcome -->
      <app-card>
        <div
          class="flex justify-between items-center mb-4 border-b border-gray-100 dark:border-gray-700 pb-2"
        >
          <div class="text-lg font-bold">
            {{ "dashboard.outcome.total" | translate }}
          </div>
          <div class="text-xl font-bold text-red-600 dark:text-red-400">
            {{ dashboardService.totalBalanceOut() | currency: "EUR" }}
          </div>
        </div>

        <div class="flex flex-col gap-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <apx-chart
              [series]="dashboardService.outcomeDonut().series"
              [chart]="dashboardService.outcomeDonut().chart"
              [legend]="dashboardService.outcomeDonut().legend"
              [responsive]="dashboardService.outcomeDonut().responsive"
              [labels]="dashboardService.outcomeDonut().labels"
              [theme]="dashboardService.outcomeDonut().theme!"
            >
            </apx-chart>

            <apx-chart
              [series]="dashboardService.outcomeBar().series"
              [chart]="dashboardService.outcomeBar().chart"
              [xaxis]="dashboardService.outcomeBar().xaxis"
              [dataLabels]="dashboardService.outcomeBar().dataLabels"
              [plotOptions]="dashboardService.outcomeBar().plotOptions"
              [theme]="dashboardService.outcomeBar().theme!"
            >
            </apx-chart>
          </div>

          <app-table
            [enableCustomActions]="true"
            [columns]="dashboardService.outcomeColumns()"
            [values]="dashboardService.outcomeValues()"
          >
            <custom-column name="category">
              <ng-template let-item="row" bodyTemplate>
                <app-category-label
                  [category]="{
                    name: item.category,
                    icon: item.icon,
                    color: item.color,
                  }"
                ></app-category-label>
              </ng-template>
            </custom-column>

            <custom-column name="amount">
              <ng-template let-item="row" bodyTemplate>
                <div class="text-red-600 dark:text-red-400 font-medium">
                  {{ item.amount | currency: item.currency }}
                  <span class="text-xs opacity-75"
                    >({{ item.percentage | percent: "1.2-2" }})</span
                  >
                </div>
              </ng-template>
            </custom-column>

            <custom-column name="actions">
              <ng-template let-item="row" bodyTemplate>
                <button
                  mat-icon-button
                  (click)="goToCategoryTransactionsDetail(item.id)"
                  aria-label="see-more"
                >
                  <mat-icon>chevron_right</mat-icon>
                </button>
              </ng-template>
            </custom-column>
          </app-table>
        </div>
      </app-card>
    </div>
  </div>
</div>
