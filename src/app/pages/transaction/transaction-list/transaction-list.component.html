<div class="flex flex-col gap-4">
  <div class="flex justify-between">
    <div class="text-2xl font-bold">
      IN: {{ totalBalanceIn() | currency : "EUR" }}
    </div>

    <div class="text-2xl font-bold">
      OUT: {{ totalBalanceOut() | currency : "EUR" }}
    </div>

    <button matButton (click)="router.navigate(NEW_TRANSACTION_ROUTE)">
      <mat-icon>add</mat-icon>
      {{ "common.add" | translate }}
    </button>
  </div>
</div>

<app-table
  [enableCustomActions]="true"
  [tableId]="'transaction-list'"
  [columns]="transactionListService.columns()"
  [values]="transactionListService.allTransactionLists()"
>
  <custom-column name="date">
    <ng-template let-item="row" bodyTemplate>
      {{ item.date | date : "dd/MM/yyyy" }}
    </ng-template>
  </custom-column>

  <custom-column name="amount">
    <ng-template let-item="row" bodyTemplate>
      <div
        [ngStyle]="{
          color:
            item.type?.name === TRANSACTION_TYPE_IN
              ? 'green'
              : item.type?.name === TRANSACTION_TYPE_OUT
              ? 'red'
              : ''
        }"
      >
        {{ item.amount | currency : item.currency?.code }}
      </div>
    </ng-template>
  </custom-column>

  <custom-column name="account">
    <ng-template let-item="row" bodyTemplate>
      {{ item.account?.name ?? "-" }}
      @if(item.toAccount?.id) { âž” {{ item.toAccount?.name ?? "-" }} }
    </ng-template>
  </custom-column>

  <custom-column name="category">
    <ng-template let-item="row" bodyTemplate>
      {{ item.category?.name }}
    </ng-template>
  </custom-column>

  <custom-column name="actions">
    <ng-template let-item="row" bodyTemplate>
      <button mat-icon-button (click)="goToDetail(item.id)" aria-label="Edit">
        <mat-icon>edit</mat-icon>
      </button>
      <button
        mat-icon-button
        (click)="askToDelete(item.id)"
        aria-label="Delete"
      >
        <mat-icon>delete</mat-icon>
      </button>
    </ng-template>
  </custom-column>
</app-table>

<!-- Category Analysis Section -->
<app-card>
  <div class="flex flex-col gap-4">
    <h3 class="text-xl font-bold">
      {{ "transaction-list.category-analysis" | translate }}
    </h3>

    <div class="flex gap-4 items-end">
      <mat-form-field appearance="outline" class="flex-1">
        <mat-label>{{
          "transaction-list.select-category" | translate
        }}</mat-label>
        <mat-select [(value)]="selectedCategoryId">
          <mat-option [value]="null">
            {{ "common.none" | translate }}
          </mat-option>
          @for (category of categoryService.allCategories(); track category.id)
          {
          <mat-option [value]="category.id">
            {{ category.name }}
          </mat-option>
          }
        </mat-select>
      </mat-form-field>
    </div>

    @if (selectedCategoryId()) {
    <mat-expansion-panel hideToggle>
      <mat-expansion-panel-header>
        <mat-panel-title>
          {{ selectedInterval() }}
          ({{ dateRangeForm.controls.start.value | date : "dd/MM/yyyy" }} -
          {{ dateRangeForm.controls.end.value | date : "dd/MM/yyyy" }})

          <mat-icon class="ml-3">edit</mat-icon>
        </mat-panel-title>
      </mat-expansion-panel-header>

      <div class="flex justify-center items-center gap-2">
        <div class="flex flex-col gap-2">
          <form
            [formGroup]="dateRangeForm"
            (ngSubmit)="onSubmit()"
            class="flex flex-col gap-2"
          >
            <mat-form-field appearance="outline">
              <mat-label>{{ "dashboard.date-range" | translate }}</mat-label>
              <mat-date-range-input [rangePicker]="picker">
                <input
                  matStartDate
                  placeholder="Start date"
                  formControlName="start"
                />
                <input
                  matEndDate
                  placeholder="End date"
                  formControlName="end"
                  (dateChange)="onSubmit()"
                />
              </mat-date-range-input>

              <mat-datepicker-toggle
                matIconSuffix
                [for]="picker"
              ></mat-datepicker-toggle>
              <mat-date-range-picker #picker></mat-date-range-picker>
            </mat-form-field>
          </form>

          <div class="flex gap-2">
            <button
              mat-raised-button
              color="secondary"
              type="submit"
              (click)="selectLastNDays(30)"
            >
              {{ "dashboard.select-last-30-days" | translate }}
            </button>

            <button
              mat-raised-button
              color="secondary"
              type="submit"
              (click)="selectLastNDays(90)"
            >
              {{ "dashboard.select-last-90-days" | translate }}
            </button>

            <button
              mat-raised-button
              color="secondary"
              type="submit"
              (click)="selectLastNDays(365)"
            >
              {{ "dashboard.select-last-year" | translate }}
            </button>
          </div>
        </div>
      </div>
    </mat-expansion-panel>

    @if (categoryTransactions().length > 0) {
    <app-card>
      <div class="flex flex-col xl:flex-row justify-center items-center gap-3">
        <apx-chart
          class="w-full"
          [series]="categoryBarChart().series"
          [chart]="categoryBarChart().chart"
          [xaxis]="categoryBarChart().xaxis"
          [dataLabels]="categoryBarChart().dataLabels"
          [plotOptions]="categoryBarChart().plotOptions"
        >
        </apx-chart>
      </div>
    </app-card>
    } @else {
    <div class="text-center text-gray-500 py-4">
      {{ "transaction-list.no-data-for-category" | translate }}
    </div>
    } }
  </div>
</app-card>
