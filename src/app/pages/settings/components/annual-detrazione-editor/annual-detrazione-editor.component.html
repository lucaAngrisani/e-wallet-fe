<h2 mat-dialog-title>
  {{
    (data
      ? "settings.annual-detrazioni.edit"
      : "settings.annual-detrazioni.add"
    ) | translate
  }}
</h2>

<mat-dialog-content>
  <form [formGroup]="form" class="flex flex-col gap-4 min-w-[500px]">
    <mat-form-field appearance="outline" class="mt-2">
      <mat-label>{{ "common.year" | translate }}</mat-label>
      <input
        title="{{ 'common.year' | translate }}"
        matInput
        type="number"
        formControlName="year"
        [readonly]="!!data"
      />
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>{{ "detrazione.massimo-detraibile" | translate }}</mat-label>
      <input
        matInput
        type="number"
        formControlName="massimoDetraibile"
        title="{{ 'detrazione.massimo-detraibile' | translate }}"
        required
      />
    </mat-form-field>

    <div class="flex justify-between items-center">
      <h3>{{ "settings.detrazioni.title" | translate }}</h3>
      <button
        mat-icon-button
        color="primary"
        (click)="addDetrazione()"
        type="button"
      >
        <mat-icon>add</mat-icon>
      </button>
    </div>

    <div formArrayName="detrazioni">
      @for (item of detrazioniArray.controls; track i; let i = $index) {
        <div
          [formGroupName]="i"
          class="detrazione-item flex flex-col sm:flex-row gap-2"
        >
          <mat-form-field appearance="outline" class="flex-1">
            <mat-label>{{ "settings.detrazioni.title" | translate }}</mat-label>
            <mat-select formControlName="detrazioneId">
              @for (det of availableDetrazioni(); track det.id) {
                <mat-option [value]="det.id">
                  {{ det.name }}
                </mat-option>
              }
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="w-32">
            <mat-label>{{ "detrazione.franchigia" | translate }}</mat-label>
            <input
              matInput
              type="number"
              formControlName="franchigia"
              title="{{ 'detrazione.franchigia' | translate }}"
            />
          </mat-form-field>

          <mat-form-field appearance="outline" class="w-32">
            <mat-label>{{ "detrazione.massimale" | translate }}</mat-label>
            <input
              matInput
              type="number"
              formControlName="massimale"
              title="{{ 'detrazione.massimale' | translate }}"
            />
          </mat-form-field>

          <button
            mat-icon-button
            color="warn"
            (click)="removeDetrazione(i)"
            type="button"
          >
            <mat-icon>delete</mat-icon>
          </button>
        </div>
      } @empty {
        <div
          class="text-gray-500 italic text-center p-4"
        >
          {{ "settings.annual-detrazioni.no-items" | translate }}
        </div>
      }
    </div>
  </form>
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-button (click)="onCancel()">
    {{ "common.cancel" | translate }}
  </button>
  <button
    mat-flat-button
    color="primary"
    (click)="onSubmit()"
    [disabled]="form.invalid"
  >
    {{ "common.save" | translate }}
  </button>
</mat-dialog-actions>
